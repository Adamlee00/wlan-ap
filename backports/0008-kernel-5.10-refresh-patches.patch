From cebbb0ffa366e356268afe15fb243682313e02fc Mon Sep 17 00:00:00 2001
From: Adrian Schmutzler <freifunk@adrianschmutzler.de>
Date: Tue, 16 Feb 2021 23:39:32 +0100
Subject: [PATCH 08/22] kernel: 5.10: refresh patches

Signed-off-by: Adrian Schmutzler <freifunk@adrianschmutzler.de>
---
 .../generic/hack-5.10/531-debloat_lzma.patch  | 33 ++++++++++---------
 ...t-command-line-parameters-from-users.patch | 10 +++---
 ...ble-add-offload-support-for-xmit-pat.patch | 15 +++++----
 ...dd-support-for-threaded-NAPI-polling.patch | 15 +++++----
 .../pending-5.10/834-ledtrig-libata.patch     |  4 +--
 5 files changed, 41 insertions(+), 36 deletions(-)

diff --git a/target/linux/generic/hack-5.10/531-debloat_lzma.patch b/target/linux/generic/hack-5.10/531-debloat_lzma.patch
index 0854872ffa..2f70eee3e9 100644
--- a/target/linux/generic/hack-5.10/531-debloat_lzma.patch
+++ b/target/linux/generic/hack-5.10/531-debloat_lzma.patch
@@ -710,26 +710,26 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
  {
    UInt32 dicSize;
    Byte d;
-@@ -935,33 +883,11 @@ static SRes LzmaDec_AllocateProbs2(CLzma
+@@ -935,7 +883,7 @@ static SRes LzmaDec_AllocateProbs2(CLzma
    return SZ_OK;
  }
  
 -SRes LzmaDec_AllocateProbs(CLzmaDec *p, const Byte *props, unsigned propsSize, ISzAlloc *alloc)
--{
--  CLzmaProps propNew;
--  RINOK(LzmaProps_Decode(&propNew, props, propsSize));
--  RINOK(LzmaDec_AllocateProbs2(p, &propNew, alloc));
--  p->prop = propNew;
--  return SZ_OK;
--}
--
--SRes LzmaDec_Allocate(CLzmaDec *p, const Byte *props, unsigned propsSize, ISzAlloc *alloc)
 +static SRes LzmaDec_AllocateProbs(CLzmaDec *p, const Byte *props, unsigned propsSize, ISzAlloc *alloc)
  {
    CLzmaProps propNew;
--  SizeT dicBufSize;
    RINOK(LzmaProps_Decode(&propNew, props, propsSize));
-   RINOK(LzmaDec_AllocateProbs2(p, &propNew, alloc));
+@@ -943,28 +891,6 @@ SRes LzmaDec_AllocateProbs(CLzmaDec *p,
+   p->prop = propNew;
+   return SZ_OK;
+ }
+-
+-SRes LzmaDec_Allocate(CLzmaDec *p, const Byte *props, unsigned propsSize, ISzAlloc *alloc)
+-{
+-  CLzmaProps propNew;
+-  SizeT dicBufSize;
+-  RINOK(LzmaProps_Decode(&propNew, props, propsSize));
+-  RINOK(LzmaDec_AllocateProbs2(p, &propNew, alloc));
 -  dicBufSize = propNew.dicSize;
 -  if (p->dic == 0 || dicBufSize != p->dicBufSize)
 -  {
@@ -742,9 +742,12 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
 -    }
 -  }
 -  p->dicBufSize = dicBufSize;
-   p->prop = propNew;
-   return SZ_OK;
- }
+-  p->prop = propNew;
+-  return SZ_OK;
+-}
+ 
+ SRes LzmaDecode(Byte *dest, SizeT *destLen, const Byte *src, SizeT *srcLen,
+     const Byte *propData, unsigned propSize, ELzmaFinishMode finishMode,
 --- a/lib/lzma/LzmaEnc.c
 +++ b/lib/lzma/LzmaEnc.c
 @@ -53,7 +53,7 @@ void LzmaEncProps_Init(CLzmaEncProps *p)
diff --git a/target/linux/generic/pending-5.10/330-MIPS-kexec-Accept-command-line-parameters-from-users.patch b/target/linux/generic/pending-5.10/330-MIPS-kexec-Accept-command-line-parameters-from-users.patch
index 5a0e44b76b..2808c95322 100644
--- a/target/linux/generic/pending-5.10/330-MIPS-kexec-Accept-command-line-parameters-from-users.patch
+++ b/target/linux/generic/pending-5.10/330-MIPS-kexec-Accept-command-line-parameters-from-users.patch
@@ -267,15 +267,15 @@ Signed-off-by: Yousong Zhou <yszhou4tech@gmail.com>
 +	EXPORT(kexec_argv_buf)
 +	.skip		KEXEC_COMMAND_LINE_SIZE
 +	.size		kexec_argv_buf, KEXEC_COMMAND_LINE_SIZE
++
++kexec_argv:
++	EXPORT(kexec_argv)
++	.skip		KEXEC_ARGV_SIZE
++	.size		kexec_argv, KEXEC_ARGV_SIZE
  
 -relocate_new_kernel_size:
 -	EXPORT(relocate_new_kernel_size)
 -	PTR		relocate_new_kernel_end - relocate_new_kernel
 -	.size		relocate_new_kernel_size, PTRSIZE
-+kexec_argv:
-+	EXPORT(kexec_argv)
-+	.skip		KEXEC_ARGV_SIZE
-+	.size		kexec_argv, KEXEC_ARGV_SIZE
-+
 +kexec_relocate_new_kernel_end:
 +	EXPORT(kexec_relocate_new_kernel_end)
diff --git a/target/linux/generic/pending-5.10/640-11-netfilter-flowtable-add-offload-support-for-xmit-pat.patch b/target/linux/generic/pending-5.10/640-11-netfilter-flowtable-add-offload-support-for-xmit-pat.patch
index 5e3c7e031a..508dc90e14 100644
--- a/target/linux/generic/pending-5.10/640-11-netfilter-flowtable-add-offload-support-for-xmit-pat.patch
+++ b/target/linux/generic/pending-5.10/640-11-netfilter-flowtable-add-offload-support-for-xmit-pat.patch
@@ -85,12 +85,14 @@ tag to the driver.
 -	n = dst_neigh_lookup(dst_cache, daddr);
 -	if (!n)
 -		return -ENOENT;
-+	this_tuple = &flow->tuplehash[dir].tuple;
- 
+-
 -	read_lock_bh(&n->lock);
 -	nud_state = n->nud_state;
 -	ether_addr_copy(ha, n->ha);
 -	read_unlock_bh(&n->lock);
++	this_tuple = &flow->tuplehash[dir].tuple;
+ 
+-	if (!(nud_state & NUD_VALID)) {
 +	switch (this_tuple->xmit_type) {
 +	case FLOW_OFFLOAD_XMIT_DIRECT:
 +		ether_addr_copy(ha, this_tuple->out.h_dest);
@@ -102,8 +104,7 @@ tag to the driver.
 +		n = dst_neigh_lookup(dst_cache, daddr);
 +		if (!n)
 +			return -ENOENT;
- 
--	if (!(nud_state & NUD_VALID)) {
++
 +		read_lock_bh(&n->lock);
 +		nud_state = n->nud_state;
 +		ether_addr_copy(ha, n->ha);
@@ -143,8 +144,7 @@ tag to the driver.
 +	struct flow_action_entry *entry;
 +	struct net_device *dev;
 +	int ifindex;
- 
--	rt = (struct rtable *)flow->tuplehash[dir].tuple.dst_cache;
++
 +	this_tuple = &flow->tuplehash[dir].tuple;
 +	switch (this_tuple->xmit_type) {
 +	case FLOW_OFFLOAD_XMIT_DIRECT:
@@ -158,7 +158,8 @@ tag to the driver.
 +	default:
 +		return;
 +	}
-+
+ 
+-	rt = (struct rtable *)flow->tuplehash[dir].tuple.dst_cache;
 +	dev = dev_get_by_index(net, ifindex);
 +	if (!dev)
 +		return;
diff --git a/target/linux/generic/pending-5.10/690-net-add-support-for-threaded-NAPI-polling.patch b/target/linux/generic/pending-5.10/690-net-add-support-for-threaded-NAPI-polling.patch
index 79b7832f2a..2979934926 100644
--- a/target/linux/generic/pending-5.10/690-net-add-support-for-threaded-NAPI-polling.patch
+++ b/target/linux/generic/pending-5.10/690-net-add-support-for-threaded-NAPI-polling.patch
@@ -214,7 +214,7 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
  	napi_hash_del(napi);
  	list_del_rcu(&napi->dev_list);
  	napi_free_frags(napi);
-@@ -6788,52 +6881,18 @@ EXPORT_SYMBOL(__netif_napi_del);
+@@ -6788,53 +6881,19 @@ EXPORT_SYMBOL(__netif_napi_del);
  
  static int napi_poll(struct napi_struct *n, struct list_head *repoll)
  {
@@ -228,7 +228,8 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
  	have = netpoll_poll_lock(n);
  
 -	weight = n->weight;
--
++	work = __napi_poll(n, &do_repoll);
+ 
 -	/* This NAPI_STATE_SCHED test is for avoiding a race
 -	 * with netpoll's poll_napi().  Only the entity which
 -	 * obtains the lock and sees NAPI_STATE_SCHED set will
@@ -246,8 +247,8 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
 -			    n->poll, work, weight);
 -
 -	if (likely(work < weight))
--		goto out_unlock;
-+	work = __napi_poll(n, &do_repoll);
++	if (!do_repoll)
+ 		goto out_unlock;
  
 -	/* Drivers must not modify the NAPI state if they
 -	 * consume the entire weight.  In such cases this code
@@ -256,8 +257,7 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
 -	 */
 -	if (unlikely(napi_disable_pending(n))) {
 -		napi_complete(n);
-+	if (!do_repoll)
- 		goto out_unlock;
+-		goto out_unlock;
 -	}
 -
 -	if (n->gro_bitmask) {
@@ -268,9 +268,10 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
 -	}
 -
 -	gro_normal_list(n);
- 
+-
  	/* Some drivers may have called napi_schedule
  	 * prior to exhausting their budget.
+ 	 */
 @@ -11288,6 +11347,10 @@ static int __init net_dev_init(void)
  		sd->backlog.weight = weight_p;
  	}
diff --git a/target/linux/generic/pending-5.10/834-ledtrig-libata.patch b/target/linux/generic/pending-5.10/834-ledtrig-libata.patch
index 623e48085d..a52e712d8c 100644
--- a/target/linux/generic/pending-5.10/834-ledtrig-libata.patch
+++ b/target/linux/generic/pending-5.10/834-ledtrig-libata.patch
@@ -106,11 +106,11 @@ Signed-off-by: Daniel Golle <daniel@makrotopia.org>
 +	for (i = 0; i < host->n_ports; i++) {
 +		if (unlikely(!host->ports[i]->ledtrig))
 +			continue;
-+
+ 
 +		snprintf(host->ports[i]->ledtrig_name,
 +			sizeof(host->ports[i]->ledtrig_name), "ata%u",
 +			host->ports[i]->print_id);
- 
++
 +		host->ports[i]->ledtrig->name = host->ports[i]->ledtrig_name;
 +
 +		if (led_trigger_register(host->ports[i]->ledtrig)) {
-- 
2.25.1

