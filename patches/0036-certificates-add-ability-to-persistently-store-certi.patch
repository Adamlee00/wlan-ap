From 4c0d4870b8b7d2d816346b47e9e7f311366dedfc Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Sun, 23 May 2021 09:59:53 +0200
Subject: [PATCH 1/4] certificates: add ability to persistently store
 certificates

Signed-off-by: John Crispin <john@phrozen.org>
---
 package/base-files/files/lib/upgrade/nand.sh             | 9 +++++++++
 .../files/arch/arm/boot/dts/qcom-ipq4019-xx8300.dtsi     | 3 +--
 .../linux/realtek/dts/rtl8392_edgecore_ecs4100-12ph.dts  | 8 ++++++--
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/package/base-files/files/lib/upgrade/nand.sh b/package/base-files/files/lib/upgrade/nand.sh
index ab3db4cdf2..36977244bc 100644
--- a/package/base-files/files/lib/upgrade/nand.sh
+++ b/package/base-files/files/lib/upgrade/nand.sh
@@ -157,6 +157,8 @@ nand_upgrade_prepare_ubi() {
 	local kern_ubivol="$( nand_find_volume $ubidev $CI_KERNPART )"
 	local root_ubivol="$( nand_find_volume $ubidev $CI_ROOTPART )"
 	local data_ubivol="$( nand_find_volume $ubidev rootfs_data )"
+	local cert_ubivol="$( nand_find_volume $ubidev certificates )"
+	local cert_mtd="$(find_mtd_index certificates)"
 
 	local ubiblk ubiblkvol
 	for ubiblk in /dev/ubiblock*_? ; do
@@ -196,6 +198,13 @@ nand_upgrade_prepare_ubi() {
 		fi
 	fi
 
+	if [ -z "$cert_ubivol" -a ! "$cert_mtd" ]; then
+		if ! ubimkvol /dev/$ubidev -N certificates -s 2MiB; then
+			echo "cannot create certificates volume"
+			return 1;
+		fi
+	fi
+
 	# create rootfs_data for non-ubifs rootfs
 	if [ "$rootfs_type" != "ubifs" ]; then
 		local availeb=$(cat /sys/devices/virtual/ubi/$ubidev/avail_eraseblocks)
diff --git a/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4019-xx8300.dtsi b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4019-xx8300.dtsi
index 8f971e505c..0f1f083a5b 100644
--- a/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4019-xx8300.dtsi
+++ b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4019-xx8300.dtsi
@@ -229,9 +229,8 @@
 			};
 
 			partition@b880000 {
-				label = "syscfg";
+				label = "certificates";
 				reg = <0xb880000 0x4680000>;
-				read-only;
 			};
 		};
 	};
diff --git a/target/linux/realtek/dts/rtl8392_edgecore_ecs4100-12ph.dts b/target/linux/realtek/dts/rtl8392_edgecore_ecs4100-12ph.dts
index 303b79ac83..7a228aea86 100644
--- a/target/linux/realtek/dts/rtl8392_edgecore_ecs4100-12ph.dts
+++ b/target/linux/realtek/dts/rtl8392_edgecore_ecs4100-12ph.dts
@@ -176,11 +176,15 @@
 				reg = <0x100000 0x100000>;
 				read-only;
 			};
-			partition@b260000 {
+			partition@200000 {
 				label = "firmware";
-				reg = <0x200000 0xe00000>;
+				reg = <0x200000 0xdf0000>;
 				compatible = "openwrt,uimage", "denx,uimage";
 			};
+			partition@ff0000 {
+				label = "certificates";
+				reg = <0xff0000 0x10000>;
+			};
 		};
 	};
 };
-- 
2.25.1

